# 実装メモ

## 今回

　パラグラフ間の改行、hr（dir+pによるテキストコピーできる場面転換）をmarked.jsから呼び出すようにした。

## 以前

## 7

### ルビ

　今回は成功した。ルビを独自処理するコードを書き、[marked.js][]から呼び出した。

　[marked.js][]がもつ[renderer][]のうち、ルビが入りうるブロック要素（`heading`,`listitem`,`paragraph`,`table`,`strong`,`em`,`del`,`text`）の中で独自パースを呼び出した。
　ルビ用メタ文字《をエスケープする機能だけは上手くいかなかった。なぜか変換されてしまった。おそらく２回以上繰り返されているのだと思われる。
　そこで[hooks][]の`postprocess`メソッドを使い、パースが終了したあとでエスケープ処理を呼び出した。つまり`｜《`を`《`に変換した。これで要件を満たせたと思う。

### パラグラフ間の改行

　残った問題がある。パラグラフ間の改行が消えてしまう。これは[marked.js][]の仕様である。独自処理を実装せねばならいだろう。

[marked.js]:https://marked.js.org/
[extensions]:https://marked.js.org/using_pro#extensions
[renderer]:https://marked.js.org/using_pro#renderer
[hooks]:https://marked.js.org/using_pro#hooks

## 6

　Markedの[extensions][]でRubyを実装してみた。残念ながらパイプ付の形式しかまともに動作しない。パイプ省略型も実装したが壊れてしまっている。ルビの前後にあるはずのテキストが消えてしまう。他のマークダウンの要素内にルビがあるときも動作しない。`<code>`内だけはパースされず正常に表示される。

# 出力《しゅつりょく》テスト

　さあ、*ここを強調*するよ。

---

　今、山田《やまだ》太郎《たろう》は笑《わら》った。

　そう、｜Oh, my god!《おお神よ》さらば。

　｜一行《いちぎょう》あたり｜二《ふた》つのパイプ付ルビがある。

　ルビの*前後*に、｜山田《やまだ》｜太郎《たろう》、*他*のマークダウンがある。

## 他のマークダウン要素の中にルビがある場合

　強調の中にルビ*｜山田《やまだ》*がある。

　リンクの中にルビ[｜山田《やまだ》][1]がある。

[1]:https://www.google.co.jp/

　[｜山田《やまだ》](https://www.google.co.jp/)

　`<code>`の中にルビがある。`｜山田《やまだ》`

　`<pre><code>`の中にルビがある。

```markdown
｜山田《やまだ》
```

````markdown
```markdown
｜山田《やまだ》
```
````

## エスケープ

　山田｜《そのまま》

　｜《の前にパイプ文字｜を入れたら《がそのまま使える。変換されない箇所ならパイプを入れずともそのまま使える。でも、変換される部分で《を使いたいときは《の前に｜を入れることで《の文字をそのまま出力することができる。

## 改行

　パラグラフ１の１行目
　パラグラフ１の２行目

　パラグラフ２の１行目
　パラグラフ２の２行目


　パラグラフ３の１行目
　パラグラフ３の２行目

# 次の見出し

　あああああああああ。

<!--

# 既知のバグ

* ruby記法は強制的に置換される

## ruby記法は強制的に置換される

　`<code>`内に書いたruby記法は置換して欲しくない。でも置換されてしまう。

````markdown
```markdown
｜置換《ちかん》されたくないのに
```
````

````markdown
｜置換《ちかん》されたくないのに
````


　marked.jsのTokenizerで実装したいが、上手くできない。

## パラグラフ間の`<br>`がされない

　小論文などはそれでいい。けれどWEB小説などで、あえて`<br>`が欲しいときがある。それをMarkdownの改行でそのまま表現したい。なのに[marked.js][]では消えてしまう。`marked.setOptions({breaks:true})`で出力されるのは、あくまでパラグラフ*内*の改行であって、パラグラフ*間*の改行ではない。

-->

